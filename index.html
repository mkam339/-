<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tawiq Redux - All Code</title>
    <style>
        body {
            font-family: 'PT Sans', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
            direction: ltr;
        }
        h1, h2 {
            color: #333;
            border-bottom: 2px solid #3CB371;
            padding-bottom: 10px;
        }
        h2 {
            margin-top: 40px;
            font-family: monospace;
            background: #e0e0e0;
            padding: 5px 10px;
            border-radius: 5px;
        }
        pre {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-x: auto;
        }
        code {
            font-family: 'Courier New', Courier, monospace;
        }
    </style>
</head>
<body>
    <h1>Tawiq Redux - شيفرة المشروع الكاملة</h1>

    <h2>package.json</h2>
    <pre><code>
{
  "name": "nextn",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev --turbopack -p 9002",
    "genkit:dev": "genkit start -- tsx src/ai/dev.ts",
    "genkit:watch": "genkit start -- tsx --watch src/ai/dev.ts",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "typecheck": "tsc --noEmit"
  },
  "dependencies": {
    "@genkit-ai/googleai": "^1.14.1",
    "@genkit-ai/next": "^1.14.1",
    "@hookform/resolvers": "^4.1.3",
    "@radix-ui/react-accordion": "^1.2.3",
    "@radix-ui/react-alert-dialog": "^1.1.6",
    "@radix-ui/react-avatar": "^1.1.3",
    "@radix-ui/react-checkbox": "^1.1.4",
    "@radix-ui/react-collapsible": "^1.1.11",
    "@radix-ui/react-dialog": "^1.1.6",
    "@radix-ui/react-dropdown-menu": "^2.1.6",
    "@radix-ui/react-label": "^2.1.2",
    "@radix-ui/react-menubar": "^1.1.6",
    "@radix-ui/react-popover": "^1.1.6",
    "@radix-ui/react-progress": "^1.1.2",
    "@radix-ui/react-radio-group": "^1.2.3",
    "@radix-ui/react-scroll-area": "^1.2.3",
    "@radix-ui/react-select": "^2.1.6",
    "@radix-ui/react-separator": "^1.1.2",
    "@radix-ui/react-slider": "^1.2.3",
    "@radix-ui/react-slot": "^1.2.3",
    "@radix-ui/react-switch": "^1.1.3",
    "@radix-ui/react-tabs": "^1.1.3",
    "@radix-ui/react-toast": "^1.2.6",
    "@radix-ui/react-tooltip": "^1.1.8",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "date-fns": "^3.6.0",
    "dotenv": "^16.5.0",
    "embla-carousel-react": "^8.6.0",
    "firebase": "^11.9.1",
    "firebase-admin": "^12.1.0",
    "genkit": "^1.14.1",
    "lucide-react": "^0.475.0",
    "next": "15.3.3",
    "patch-package": "^8.0.0",
    "react": "^18.3.1",
    "react-day-picker": "^8.10.1",
    "react-dom": "^18.3.1",
    "react-hook-form": "^7.54.2",
    "recharts": "^2.15.1",
    "tailwind-merge": "^3.0.1",
    "tailwindcss-animate": "^1.0.7",
    "zod": "^3.24.2"
  },
  "devDependencies": {
    "@types/node": "^20",
    "@types/react": "^18",
    "@types/react-dom": "^18",
    "genkit-cli": "^1.14.1",
    "postcss": "^8",
    "tailwindcss": "^3.4.1",
    "typescript": "^5"
  }
}
    </code></pre>

    <h2>next.config.ts</h2>
    <pre><code>
import type {NextConfig} from 'next';

const nextConfig: NextConfig = {
  /* config options here */
  typescript: {
    ignoreBuildErrors: true,
  },
  eslint: {
    ignoreDuringBuilds: true,
  },
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: 'placehold.co',
        port: '',
        pathname: '/**',
      },
    ],
  },
};

export default nextConfig;
    </code></pre>

    <h2>tailwind.config.ts</h2>
    <pre><code>
import type {Config} from 'tailwindcss';

export default {
  darkMode: ['class'],
  content: [
    './src/pages/**/*.{js,ts,jsx,tsx,mdx}',
    './src/components/**/*.{js,ts,jsx,tsx,mdx}',
    './src/app/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  theme: {
    container: {
      center: true,
      padding: '2rem',
      screens: {
        '2xl': '1400px',
      },
    },
    extend: {
      fontFamily: {
        body: ['PT Sans', 'sans-serif'],
        headline: ['PT Sans', 'sans-serif'],
        code: ['monospace'],
      },
      colors: {
        background: 'hsl(var(--background))',
        foreground: 'hsl(var(--foreground))',
        card: {
          DEFAULT: 'hsl(var(--card))',
          foreground: 'hsl(var(--card-foreground))',
        },
        popover: {
          DEFAULT: 'hsl(var(--popover))',
          foreground: 'hsl(var(--popover-foreground))',
        },
        primary: {
          DEFAULT: 'hsl(var(--primary))',
          foreground: 'hsl(var(--primary-foreground))',
        },
        secondary: {
          DEFAULT: 'hsl(var(--secondary))',
          foreground: 'hsl(var(--secondary-foreground))',
        },
        muted: {
          DEFAULT: 'hsl(var(--muted))',
          foreground: 'hsl(var(--muted-foreground))',
        },
        accent: {
          DEFAULT: 'hsl(var(--accent))',
          foreground: 'hsl(var(--accent-foreground))',
        },
        destructive: {
          DEFAULT: 'hsl(var(--destructive))',
          foreground: 'hsl(var(--destructive-foreground))',
        },
        border: 'hsl(var(--border))',
        input: 'hsl(var(--input))',
        ring: 'hsl(var(--ring))',
        chart: {
          '1': 'hsl(var(--chart-1))',
          '2': 'hsl(var(--chart-2))',
          '3': 'hsl(var(--chart-3))',
          '4': 'hsl(var(--chart-4))',
          '5': 'hsl(var(--chart-5))',
        },
        sidebar: {
          DEFAULT: 'hsl(var(--sidebar-background))',
          foreground: 'hsl(var(--sidebar-foreground))',
          primary: 'hsl(var(--sidebar-primary))',
          'primary-foreground': 'hsl(var(--sidebar-primary-foreground))',
          accent: 'hsl(var(--sidebar-accent))',
          'accent-foreground': 'hsl(var(--sidebar-accent-foreground))',
          border: 'hsl(var(--sidebar-border))',
          ring: 'hsl(var(--sidebar-ring))',
        },
      },
      borderRadius: {
        lg: 'var(--radius)',
        md: 'calc(var(--radius) - 2px)',
        sm: 'calc(var(--radius) - 4px)',
      },
      keyframes: {
        'accordion-down': {
          from: {
            height: '0',
          },
          to: {
            height: 'var(--radix-accordion-content-height)',
          },
        },
        'accordion-up': {
          from: {
            height: 'var(--radix-accordion-content-height)',
          },
          to: {
            height: '0',
          },
        },
      },
      animation: {
        'accordion-down': 'accordion-down 0.2s ease-out',
        'accordion-up': 'accordion-up 0.2s ease-out',
      },
    },
  },
  plugins: [require('tailwindcss-animate')],
} satisfies Config;
    </code></pre>

    <h2>src/app/globals.css</h2>
    <pre><code>
@tailwind base;
@tailwind components;
@tailwind utilities;

body {
  font-family: 'PT Sans', sans-serif;
}

@layer base {
  :root {
    --background: 140 71% 92%;
    --foreground: 222.2 84% 4.9%;
    --card: 140 71% 92%;
    --card-foreground: 222.2 84% 4.9%;
    --popover: 140 71% 92%;
    --popover-foreground: 222.2 84% 4.9%;
    --primary: 147 50% 47%;
    --primary-foreground: 210 40% 98%;
    --secondary: 210 40% 96.1%;
    --secondary-foreground: 222.2 47.4% 11.2%;
    --muted: 210 40% 96.1%;
    --muted-foreground: 215.4 16.3% 46.9%;
    --accent: 197 71% 73%;
    --accent-foreground: 222.2 47.4% 11.2%;
    --destructive: 0 84.2% 60.2%;
    --destructive-foreground: 210 40% 98%;
    --border: 214.3 31.8% 91.4%;
    --input: 214.3 31.8% 91.4%;
    --ring: 147 50% 47%;
    --radius: 0.5rem;
  }

  .dark {
    --background: 222.2 84% 4.9%;
    --foreground: 210 40% 98%;
    --card: 222.2 84% 4.9%;
    --card-foreground: 210 40% 98%;
    --popover: 222.2 84% 4.9%;
    --popover-foreground: 210 40% 98%;
    --primary: 147 50% 47%;
    --primary-foreground: 210 40% 98%;
    --secondary: 217.2 32.6% 17.5%;
    --secondary-foreground: 210 40% 98%;
    --muted: 217.2 32.6% 17.5%;
    --muted-foreground: 215 20.2% 65.1%;
    --accent: 197 71% 73%;
    --accent-foreground: 210 40% 98%;
    --destructive: 0 62.8% 30.6%;
    --destructive-foreground: 210 40% 98%;
    --border: 217.2 32.6% 17.5%;
    --input: 217.2 32.6% 17.5%;
    --ring: 147 50% 47%;
  }
}

@layer base {
  * {
    @apply border-border;
  }
  body {
    @apply bg-background text-foreground;
  }
  html[dir="rtl"] {
    direction: rtl;
  }
}
    </code></pre>

    <h2>src/app/layout.tsx</h2>
    <pre><code>
import type { Metadata } from 'next';
import './globals.css';
import { Toaster } from '@/components/ui/toaster';
import Header from '@/components/header';
import Footer from '@/components/footer';

export const metadata: Metadata = {
  title: 'Tawiq Redux',
  description: 'منصة طويق التعليمية',
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="ar" dir="rtl">
      <head>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link
          rel="preconnect"
          href="https://fonts.gstatic.com"
          crossOrigin="anonymous"
        />
        <link
          href="https://fonts.googleapis.com/css2?family=PT+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap"
          rel="stylesheet"
        />
      </head>
      <body className="font-body antialiased">
        <div className="flex min-h-screen flex-col">
          <Header />
          <main className="flex-grow">{children}</main>
          <Footer />
        </div>
        <Toaster />
      </body>
    </html>
  );
}
    </code></pre>

    <h2>src/app/page.tsx</h2>
    <pre><code>
import Image from 'next/image';
import { Button } from '@/components/ui/button';
import { CourseList } from '@/components/courses/course-list';
import { getCourses, getNewsImages } from '@/app/actions';
import Link from 'next/link';

export default async function Home() {
  const courses = await getCourses();
  const newsImages = await getNewsImages();
  
  return (
    <div className="container mx-auto px-6 py-8">
      <header className="relative mb-12 flex items-center justify-center">
        <div className="relative w-full max-w-6xl">
          <Image
            src="https://placehold.co/1200x500"
            alt="Hero image"
            width={1200}
            height={500}
            className="rounded-lg shadow-lg object-cover w-full"
            data-ai-hint="education banner"
            priority
          />
          <div className="absolute inset-0 bg-black/30 rounded-lg"></div>
          <div className="absolute bottom-10 flex w-full justify-center gap-x-8">
            <Button asChild size="lg" className="text-lg font-bold px-8 py-6 rounded-full shadow-lg transition-transform hover:scale-105">
              <a href="https://t.me/tawiqKSA" target="_blank" rel="noopener noreferrer">
                القناة الرئيسية
              </a>
            </Button>
            <Button asChild size="lg" variant="secondary" className="text-lg font-bold px-8 py-6 rounded-full shadow-lg transition-transform hover:scale-105">
              <Link href="/my-courses">
                واجهة المشتركين
              </Link>
            </Button>
          </div>
        </div>
      </header>
      
      <section id="courses" className="pb-12">
        <div className="flex items-center justify-between mb-6">
          <h2 className="text-3xl font-bold">أحدث الدورات</h2>
        </div>
        <CourseList courses={courses} />
      </section>

      {newsImages.length > 0 && (
        <section>
          <h3 className="text-2xl font-semibold mb-4">آخر الأخبار</h3>
          {newsImages.map((image) => (
            <div key={image.id} className="mt-8">
              <Image
                src={image.src}
                alt="الاخبار"
                width={1200}
                height={400}
                className="w-full h-auto rounded-lg shadow-md object-cover"
                data-ai-hint="news event"
              />
            </div>
          ))}
        </section>
      )}
    </div>
  );
}
    </code></pre>

    <h2>src/app/admin/page.tsx</h2>
    <pre><code>
import { getCurrentUser } from '@/lib/auth';
import { redirect } from 'next/navigation';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { getCourses, getNewsImages } from '../actions';
import { CoursesTable } from './_components/courses-table';
import { NewsImagesTable } from './_components/news-images-table';

export default async function AdminPage() {
  const user = await getCurrentUser();
  if (user?.role !== 'admin') {
    redirect('/');
  }

  const courses = await getCourses();
  const newsImages = await getNewsImages();

  return (
    <div className="container mx-auto px-6 py-12">
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-bold">لوحة المشرف</h1>
      </div>
      <Tabs defaultValue="courses" className="w-full">
        <TabsList className="grid w-full grid-cols-2">
          <TabsTrigger value="courses">إدارة الدورات</TabsTrigger>
          <TabsTrigger value="news">إدارة صور الأخبار</TabsTrigger>
        </TabsList>
        <TabsContent value="courses">
            <CoursesTable courses={courses} />
        </TabsContent>
        <TabsContent value="news">
            <NewsImagesTable newsImages={newsImages} />
        </TabsContent>
      </Tabs>
    </div>
  );
}
    </code></pre>

    <h2>src/app/my-courses/page.tsx</h2>
    <pre><code>
import { getCurrentUser } from '@/lib/auth';
import { getUserPurchases, getCourseById, getCourses } from '@/app/actions';
import { redirect } from 'next/navigation';
import { Card, CardTitle } from '@/components/ui/card';
import Image from 'next/image';
import { Button } from '@/components/ui/button';
import Link from 'next/link';
import { SuggestedCourses } from '@/components/courses/suggested-courses';

export default async function MyCoursesPage() {
  const user = await getCurrentUser();
  if (!user) {
    redirect('/');
  }

  const purchases = await getUserPurchases(user.id);
  const allCourses = await getCourses();
  const myCourses = (await Promise.all(
    purchases.map(p => getCourseById(p.courseId))
  )).filter((c): c is NonNullable<typeof c> => c !== undefined);

  return (
    <div className="container mx-auto px-6 py-12">
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-bold">دوراتي</h1>
      </div>
      {myCourses.length === 0 ? (
        <div className="text-center py-16 bg-card/50 rounded-lg">
            <h2 className="text-2xl font-semibold">لم تشترِ أي دورات بعد</h2>
            <p className="text-muted-foreground mt-2">تصفح دوراتنا وابدأ رحلتك التعليمية!</p>
            <Button asChild className="mt-4">
                <Link href="/">تصفح الدورات</Link>
            </Button>
        </div>
      ) : (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          {myCourses.map(course => (
            <Card key={course.id} className="flex gap-4 p-4 items-center shadow-md">
              <div className="relative w-28 h-20 rounded overflow-hidden flex-shrink-0">
                  <Image src={course.image} alt={course.title} fill className="object-cover" data-ai-hint="course thumbnail" />
              </div>
              <div className="flex-grow">
                <CardTitle className="text-lg">{course.title}</CardTitle>
              </div>
              <div>
                <Button asChild>
                  {/* In a real app this would link to the course content page */}
                  <div className="cursor-pointer">ابدأ الدورة</div>
                </Button>
              </div>
            </Card>
          ))}
        </div>
      )}
      
      <SuggestedCourses allCourses={allCourses} purchases={purchases} />
    </div>
  );
}
    </code></pre>

    <h2>src/lib/types.ts</h2>
    <pre><code>
export interface Course {
  id: string;
  title: string;
  description: string;
  price: number;
  image: string;
  duration: string;
  saleState: 'before' | 'after';
  whatToLearn: string[];
}

export interface NewsImage {
  id: string;
  src: string;
}

export interface User {
  id: string;
  email: string;
  username: string;
  role: 'student' | 'admin';
}

export interface Purchase {
  id: string;
  courseId: string;
  userId: string;
  purchasedAt: number;
}
    </code></pre>

    <h2>src/lib/utils.ts</h2>
    <pre><code>
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}
    </code></pre>

    <h2>src/lib/firebase.ts</h2>
    <pre><code>
import { initializeApp, getApps, getApp } from 'firebase/app';
import admin from 'firebase-admin';
import { getFirestore } from 'firebase-admin/firestore';

const firebaseConfig = {
  projectId: 'tawiq-redux',
  appId: '1:725506238999:web:2c9147bcf4480c52fc4a52',
  storageBucket: 'tawiq-redux.firebasestorage.app',
  apiKey: 'AIzaSyD3p7zht4hZC2-8NJ9bVrBUnWT0XzUEp50',
  authDomain: 'tawiq-redux.firebaseapp.com',
  measurementId: '',
  messagingSenderId: '725506238999'
};

// Initialize Firebase for client-side
const app = getApps().length ? getApp() : initializeApp(firebaseConfig);

// Initialize Firebase Admin for server-side
if (!admin.apps.length) {
  try {
    admin.initializeApp({
      credential: admin.credential.applicationDefault(),
    });
  } catch (error) {
    console.log('Firebase admin initialization error', error);
  }
}


const db = getFirestore();

export { app, db };
    </code></pre>

    <h2>src/lib/auth.ts</h2>
    <pre><code>
import { cookies } from 'next/headers';
import type { User } from './types';
import { getUserById } from './data';

const SESSION_COOKIE_NAME = 'tawiq_session';
export const ADMIN_CODE = 'moshrif192837465';

export async function createSession(userId: string) {
  cookies().set(SESSION_COOKIE_NAME, userId, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    maxAge: 60 * 60 * 24 * 7, // One week
    path: '/',
  });
}

export async function getCurrentUser(): Promise<User | null> {
  const userId = cookies().get(SESSION_COOKIE_NAME)?.value;
  if (!userId) return null;

  try {
    const user = await getUserById(userId);
    if (!user) {
      // Clean up invalid cookie
      await deleteSession();
      return null;
    }

    const { password, ...userWithoutPassword } = user;
    return userWithoutPassword;
  } catch (error) {
    console.error("Error in getCurrentUser:", error);
    return null;
  }
}

export async function deleteSession() {
  cookies().delete(SESSION_COOKIE_NAME);
}
    </code></pre>

    <h2>src/lib/data.ts</h2>
    <pre><code>
import type { Course, NewsImage, User, Purchase } from '@/lib/types';
import { db } from './firebase';

// Let's use Firestore for data storage
const usersCollection = db.collection('users');
const coursesCollection = db.collection('courses');
const newsImagesCollection = db.collection('newsImages');
const purchasesCollection = db.collection('purchases');

export async function getUsers(): Promise<(User & { password?: string })[]> {
    try {
        const snapshot = await usersCollection.get();
        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as User & { password?: string }));
    } catch (error) {
        console.error("Error getting users:", error);
        return [];
    }
}

export async function getUserById(id: string): Promise<(User & { password?: string }) | null> {
    try {
        const doc = await usersCollection.doc(id).get();
        if (!doc.exists) return null;
        return { id: doc.id, ...doc.data() } as User & { password?: string };
    } catch (error) {
        console.error(`Error getting user by id ${id}:`, error);
        return null;
    }
}

export async function getUserByEmailOrUsername(emailOrUsername: string): Promise<(User & { password?: string }) | null> {
    try {
        const emailQuery = await usersCollection.where('email', '==', emailOrUsername).limit(1).get();
        if (!emailQuery.empty) {
            const doc = emailQuery.docs[0];
            return { id: doc.id, ...doc.data() } as User & { password?: string };
        }
        const usernameQuery = await usersCollection.where('username', '==', emailOrUsername).limit(1).get();
        if (!usernameQuery.empty) {
            const doc = usernameQuery.docs[0];
            return { id: doc.id, ...doc.data() } as User & { password?: string };
        }
        return null;
    } catch (error) {
        console.error(`Error getting user by email or username ${emailOrUsername}:`, error);
        return null;
    }
}

export async function createUser(user: Omit<User & { password?: string }, 'id'>): Promise<string> {
    const docRef = await usersCollection.add(user);
    return docRef.id;
}


// Courses
export async function getCourses(): Promise<Course[]> {
  try {
    const snapshot = await coursesCollection.get();
    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as Course));
  } catch (error) {
    console.error("Error getting courses:", error);
    return [];
  }
}

export async function getCourseById(id: string): Promise<Course | undefined> {
  try {
    const doc = await coursesCollection.doc(id).get();
    if (!doc.exists) return undefined;
    return { id: doc.id, ...doc.data() } as Course;
  } catch (error) {
    console.error(`Error getting course by id ${id}:`, error);
    return undefined;
  }
}

export async function saveCourseData(course: Omit<Course, 'id'>, id?: string): Promise<string> {
    if (id) {
        await coursesCollection.doc(id).set(course, { merge: true });
        return id;
    } else {
        const docRef = await coursesCollection.add(course);
        return docRef.id;
    }
}

export async function deleteCourseData(id: string): Promise<void> {
    await coursesCollection.doc(id).delete();
}

// News Images
export async function getNewsImages(): Promise<NewsImage[]> {
    try {
        const snapshot = await newsImagesCollection.orderBy('createdAt', 'desc').get();
        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as NewsImage));
    } catch (error) {
        console.error("Error getting news images:", error);
        return [];
    }
}

export async function addNewsImageData(src: string): Promise<string> {
    const docRef = await newsImagesCollection.add({ src, createdAt: new Date() });
    return docRef.id;
}

export async function deleteNewsImageData(id: string): Promise<void> {
    await newsImagesCollection.doc(id).delete();
}

// Purchases
export async function getUserPurchases(userId: string): Promise<Purchase[]> {
    try {
        const snapshot = await purchasesCollection.where('userId', '==', userId).get();
        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as Purchase));
    } catch (error) {
        console.error(`Error getting user purchases for user ${userId}:`, error);
        return [];
    }
}

export async function hasUserPurchasedCourse(userId: string, courseId: string): Promise<boolean> {
    try {
        const snapshot = await purchasesCollection
            .where('userId', '==', userId)
            .where('courseId', '==', courseId)
            .limit(1)
            .get();
        return !snapshot.empty;
    } catch (error) {
        console.error(`Error checking purchase for user ${userId} and course ${courseId}:`, error);
        return false;
    }
}

export async function createPurchase(userId: string, courseId: string): Promise<string> {
    const purchase = {
        userId,
        courseId,
        purchasedAt: Date.now(),
    };
    const docRef = await purchasesCollection.add(purchase);
    return docRef.id;
}
    </code></pre>

    <h2>src/app/actions.ts</h2>
    <pre><code>
"use server";

import { revalidatePath } from "next/cache";
import { z } from "zod";
import { ADMIN_CODE, createSession, deleteSession, getCurrentUser } from "@/lib/auth";
import { 
    getCourses as getCoursesData,
    getCourseById as getCourseByIdData,
    getNewsImages as getNewsImagesData,
    getUserPurchases as getUserPurchasesData,
    saveCourseData,
    deleteCourseData,
    addNewsImageData,
    deleteNewsImageData,
    getUserByEmailOrUsername,
    createUser,
    hasUserPurchasedCourse,
    createPurchase,
} from "@/lib/data";
import type { Course } from "@/lib/types";

// Auth Actions
const loginSchema = z.object({
  emailOrUsername: z.string(),
  password: z.string(),
});

export async function login(values: z.infer<typeof loginSchema>) {
  const parsed = loginSchema.safeParse(values);
  if (!parsed.success) {
    return { error: "البيانات المدخلة غير صالحة." };
  }

  const { emailOrUsername, password } = parsed.data;

  const user = await getUserByEmailOrUsername(emailOrUsername);

  if (!user || user.password !== password) {
    return { error: "البريد الإلكتروني أو كلمة المرور غير صحيحة." };
  }

  await createSession(user.id);
  return { success: true };
}

export async function logout() {
  await deleteSession();
  revalidatePath('/', 'layout');
}

const registerSchema = z.object({
  email: z.string().email(),
  username: z.string().min(3),
  password: z.string().min(6),
  adminCode: z.string().optional(),
});

export async function register(values: z.infer<typeof registerSchema>) {
  const parsed = registerSchema.safeParse(values);
  if (!parsed.success) {
    return { error: "البيانات المدخلة غير صالحة." };
  }

  const { email, username, password, adminCode } = parsed.data;

  const existingUser = await getUserByEmailOrUsername(email);
  if (existingUser) {
    return { error: "البريد الإلكتروني أو اسم المستخدم مسجل بالفعل." };
  }
  const existingUserByUsername = await getUserByEmailOrUsername(username);
  if (existingUserByUsername) {
    return { error: "البريد الإلكتروني أو اسم المستخدم مسجل بالفعل." };
  }


  const role = adminCode === ADMIN_CODE ? "admin" : "student";
  
  const userId = await createUser({ email, username, password, role });

  await createSession(userId);
  return { success: true, role };
}

// Data Getters
export async function getCourses(): Promise<Course[]> {
  return await getCoursesData();
}

export async function getCourseById(id: string): Promise<Course | undefined> {
  return await getCourseByIdData(id);
}

export async function getNewsImages() {
  return await getNewsImagesData();
}

export async function getUserPurchases(userId: string) {
  return await getUserPurchasesData(userId);
}


// Purchase Action
export async function quickBuyCourse(courseId: string) {
    const user = await getCurrentUser();
    if (!user) {
      return { error: "يجب تسجيل الدخول أولاً لإتمام عملية الشراء." };
    }
  
    const course = await getCourseByIdData(courseId);
    if (!course) {
      return { error: "الدورة غير موجودة." };
    }

    const existingPurchase = await hasUserPurchasedCourse(user.id, courseId);

    if (existingPurchase) {
      return { error: "لقد قمت بشراء هذه الدورة بالفعل." };
    }
  
    await createPurchase(user.id, courseId);
  
    revalidatePath('/my-courses');
    return { success: true };
}

// Admin Actions
const courseSchema = z.object({
    id: z.string().optional(),
    title: z.string().min(1, 'العنوان مطلوب'),
    description: z.string().min(1, 'الوصف مطلوب'),
    price: z.coerce.number().min(0, 'السعر يجب أن يكون إيجابيًا'),
    duration: z.string().min(1, 'المدة مطلوبة'),
    image: z.string().url('رابط الصورة غير صالح'),
    saleState: z.enum(['before', 'after']),
    whatToLearn: z.string().transform(val => val.split(',').map(s => s.trim()))
});

export async function saveCourse(formData: FormData) {
    const user = await getCurrentUser();
    if (user?.role !== 'admin') {
        return { error: 'غير مصرح لك' };
    }

    const values = Object.fromEntries(formData.entries());
    const parsed = courseSchema.safeParse(values);

    if (!parsed.success) {
        return { error: 'البيانات غير صالحة', errors: parsed.error.flatten().fieldErrors };
    }
    
    const { id, ...courseData } = parsed.data;

    await saveCourseData(courseData, id);

    revalidatePath('/');
    revalidatePath('/admin');
    revalidatePath('/my-courses');
    return { success: true };
}

export async function deleteCourse(courseId: string) {
    const user = await getCurrentUser();
    if (user?.role !== 'admin') {
        return { error: 'غير مصرح لك' };
    }
    await deleteCourseData(courseId);
    revalidatePath('/');
    revalidatePath('/admin');
    revalidatePath('/my-courses');
    return { success: true };
}

const newsImageSchema = z.object({
    src: z.string().url('رابط الصورة غير صالح')
});

export async function addNewsImage(formData: FormData) {
    const user = await getCurrentUser();
    if (user?.role !== 'admin') {
        return { error: 'غير مصرح لك' };
    }

    const values = Object.fromEntries(formData.entries());
    const parsed = newsImageSchema.safeParse(values);
    if (!parsed.success) {
        return { error: 'رابط الصورة غير صالح' };
    }
    
    await addNewsImageData(parsed.data.src);
    
    revalidatePath('/');
    revalidatePath('/admin');
    return { success: true };
}

export async function deleteNewsImage(id: string) {
    const user = await getCurrentUser();
    if (user?.role !== 'admin') {
        return { error: 'غير مصرح لك' };
    }
    await deleteNewsImageData(id);
    revalidatePath('/');
    revalidatePath('/admin');
    return { success: true };
}
    </code></pre>
    
    <h2>src/components/header.tsx</h2>
    <pre><code>
import Link from 'next/link';
import AuthButton from './auth-button';
import { getCurrentUser } from '@/lib/auth';
import { Button } from './ui/button';
import Image from 'next/image';

const Header = async () => {
  const user = await getCurrentUser();

  return (
    <header className="bg-background/80 backdrop-blur-sm border-b sticky top-0 z-50">
      <div className="container mx-auto px-6 py-3 flex items-center justify-between">
        <div className="flex items-center gap-4">
          <Link href="/" className="flex items-center gap-2">
            <Image src="https://placehold.co/40x40" alt="طويق" width={40} height={40} data-ai-hint="education logo" className="rounded-full" />
            <span className="text-xl font-bold text-primary hidden sm:inline">طويق التعليمية</span>
          </Link>
        </div>
        <nav className="hidden md:flex items-center gap-6">
          <a href="https://t.me/tawiqKSA" target="_blank" rel="noopener noreferrer" className="text-sm text-muted-foreground hover:text-foreground transition-colors">
            تواصل
          </a>
          {user && (
            <Link href="/my-courses" className="text-sm text-muted-foreground hover:text-foreground transition-colors">
              دوراتي
            </Link>
          )}
        </nav>
        <div className="flex items-center gap-3">
          {user?.role === 'admin' && (
            <Button asChild variant="secondary">
              <Link href="/admin">لوحة المشرف</Link>
            </Button>
          )}
          <AuthButton user={user} />
        </div>
      </div>
    </header>
  );
};

export default Header;
    </code></pre>

    <h2>src/components/footer.tsx</h2>
    <pre><code>
import Image from 'next/image';

const Footer = () => {
  return (
    <footer className="border-t mt-12 bg-primary text-primary-foreground">
      <div className="container mx-auto px-6 py-8 text-center text-sm">
        <div className="flex flex-col md:flex-row items-center justify-center gap-4 mb-4">
          <Image src="https://placehold.co/50x50" alt="logo" width={50} height={50} data-ai-hint="logo icon" className="rounded-full" />
          <p className="max-w-2xl text-center">
            منصة طويق التعليمية هي مساحة تعليمية مصممة خصيصًا لدعم الطلاب في اجتياز اختبار القدرات بسهولة وثقة، وتقدم المنصة مجموعة واسعة من الأدوات والخدمات مثل اختبارات مخصصة وملفات متنوعة للأسئلة وملخصات لتساعدك على تحسين مستواك بسرعة وبطريقة منظمة. مع طويق، ستجد كل ما تحتاجه لتتعلم بكفاءة وتحقق حلمك بإذن الله.
          </p>
          <Image src="https://placehold.co/50x50" alt="logo" width={50} height={50} data-ai-hint="logo icon" className="rounded-full" />
        </div>
        <div className="border-t border-primary-foreground/20 pt-6 mt-4">
          © 2025 طويق التعليمية — كل الحقوق محفوظة
        </div>
      </div>
    </footer>
  );
};

export default Footer;
    </code></pre>
</body>
</html>
